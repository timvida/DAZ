{% extends "base.html" %}

{% block title %}{{ server.name }} - RCon Console{% endblock %}

{% block page_title %}{{ server.name }}{% endblock %}
{% block page_subtitle %}RCon Console & Verwaltung{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('server_dashboard', server_id=server.id) }}" class="flex items-center gap-2 px-4 py-2 bg-[#0D1117] hover:bg-[#E32345]/10 border border-[#E32345]/30 rounded-lg transition">
    <i class="fas fa-arrow-left"></i>
    <span class="hidden lg:inline">Back to Dashboard</span>
</a>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Connection Status -->
    <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6 mb-6">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div id="connectionStatusIcon" class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-question text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white mb-1">RCon Verbindungsstatus</h2>
                    <p id="connectionStatusText" class="text-gray-400">Noch nicht getestet</p>
                    <div id="connectionDetails" class="mt-2 text-sm text-gray-500 hidden">
                        <span class="mr-4"><strong>IP:</strong> <span id="serverIP">-</span></span>
                        <span><strong>Port:</strong> <span id="serverPort">-</span></span>
                    </div>
                    <div id="configDebug" class="mt-3 p-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-xs hidden">
                        <div class="font-bold text-white mb-2">BattlEye Config Debug:</div>
                        <div id="configDebugContent" class="text-gray-400 space-y-1"></div>
                    </div>
                </div>
            </div>
            <button onclick="testConnection()" class="px-6 py-3 bg-[#E32345] hover:bg-[#c41d39] rounded-lg font-medium transition shadow-lg shadow-[#E32345]/20 flex items-center gap-2">
                <i class="fas fa-plug"></i>
                <span>Verbindung testen</span>
            </button>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Players List -->
        <div class="lg:col-span-1">
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-users text-[#E32345] text-xl"></i>
                        <h3 class="text-lg font-bold text-white">Online Spieler</h3>
                    </div>
                    <button onclick="loadPlayers()" class="px-3 py-2 bg-[#0D1117] hover:bg-[#E32345]/10 border border-[#E32345]/30 rounded-lg transition">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div class="mb-4 p-4 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-center">
                    <div class="text-3xl font-bold text-[#E32345]" id="playerCount">0</div>
                    <div class="text-sm text-gray-400">Spieler online</div>
                </div>

                <div id="playersList" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-user-slash text-4xl mb-2"></i>
                        <p>Keine Spieler online</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6 mt-6">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-bolt text-[#E32345]"></i>
                    Schnellaktionen
                </h3>
                <div class="space-y-2">
                    <div class="flex gap-2">
                        <input type="text" id="quickMessage" placeholder="Nachricht an alle..." class="flex-1 px-4 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition text-sm">
                        <button onclick="sendQuickMessage()" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <button onclick="kickAllPlayers()" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg font-medium transition text-sm">
                        <i class="fas fa-user-slash mr-2"></i>Alle Spieler kicken
                    </button>
                    <div class="grid grid-cols-2 gap-2 pt-2">
                        <button id="lockBtn" onclick="lockServer()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg font-medium transition text-sm">
                            <i class="fas fa-lock mr-2"></i>Sperren
                        </button>
                        <button id="unlockBtn" onclick="unlockServer()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg font-medium transition text-sm">
                            <i class="fas fa-unlock mr-2"></i>Entsperren
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RCon Console -->
        <div class="lg:col-span-2">
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6 h-full flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-terminal text-[#E32345] text-xl"></i>
                        <h3 class="text-lg font-bold text-white">RCon Console</h3>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="clearConsole()" class="px-3 py-2 bg-[#0D1117] hover:bg-[#E32345]/10 border border-[#E32345]/30 rounded-lg transition text-sm">
                            <i class="fas fa-trash mr-2"></i>Leeren
                        </button>
                    </div>
                </div>

                <div id="consoleOutput" class="flex-1 bg-[#0D1117] border border-[#E32345]/30 rounded-lg p-4 font-mono text-sm text-green-400 overflow-y-auto mb-4 min-h-[500px]">
                    <div class="text-gray-500">RCon Console bereit. Gib ein Kommando ein...</div>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="commandInput" placeholder="Kommando eingeben... (z.B. 'players', 'say -1 Hallo')" class="flex-1 px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition" onkeypress="if(event.key==='Enter') sendCommand()">
                    <button onclick="sendCommand()" class="px-6 py-3 bg-[#E32345] hover:bg-[#c41d39] rounded-lg font-medium transition shadow-lg shadow-[#E32345]/20">
                        <i class="fas fa-paper-plane mr-2"></i>Senden
                    </button>
                </div>

                <!-- Common Commands -->
                <div class="mt-4 p-4 bg-[#0D1117] border border-[#E32345]/30 rounded-lg">
                    <p class="text-sm text-gray-400 mb-2">HÃ¤ufige Befehle:</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickCommand('players')" class="px-3 py-1 bg-[#E32345]/20 hover:bg-[#E32345]/30 border border-[#E32345]/50 rounded text-white text-xs transition">players</button>
                        <button onclick="quickCommand('admins')" class="px-3 py-1 bg-[#E32345]/20 hover:bg-[#E32345]/30 border border-[#E32345]/50 rounded text-white text-xs transition">admins</button>
                        <button onclick="quickCommand('missions')" class="px-3 py-1 bg-[#E32345]/20 hover:bg-[#E32345]/30 border border-[#E32345]/50 rounded text-white text-xs transition">missions</button>
                        <button onclick="quickCommand('bans')" class="px-3 py-1 bg-[#E32345]/20 hover:bg-[#E32345]/30 border border-[#E32345]/50 rounded text-white text-xs transition">bans</button>
                        <button onclick="quickCommand('#lock')" class="px-3 py-1 bg-[#E32345]/20 hover:bg-[#E32345]/30 border border-[#E32345]/50 rounded text-white text-xs transition">#lock</button>
                        <button onclick="quickCommand('#unlock')" class="px-3 py-1 bg-[#E32345]/20 hover:bg-[#E32345]/30 border border-[#E32345]/50 rounded text-white text-xs transition">#unlock</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-[#1A1F29] border border-[#E32345]/30 rounded-2xl max-w-md w-full p-8">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-[#E32345]/30 border-t-[#E32345] rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-white mb-2" id="loadingMessage">LÃ¤dt...</h3>
        </div>
    </div>
</div>

<script>
    const serverId = {{ server.id }};
    let playersInterval = null;

    document.addEventListener('DOMContentLoaded', function() {
        testConnection();
        loadPlayers();
        startPlayersRefresh();
    });

    function testConnection() {
        showLoading('Teste Verbindung...');
        fetch(`/api/server/${serverId}/rcon/test`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            updateConnectionStatus(data.success, data.message, data.details);
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            updateConnectionStatus(false, 'Verbindungsfehler', {});
        });
    }

    function updateConnectionStatus(success, message, details) {
        const icon = document.getElementById('connectionStatusIcon');
        const text = document.getElementById('connectionStatusText');
        const detailsDiv = document.getElementById('connectionDetails');
        const debugDiv = document.getElementById('configDebug');
        const debugContent = document.getElementById('configDebugContent');

        if (success) {
            icon.className = 'w-12 h-12 bg-green-500 rounded-full flex items-center justify-center';
            icon.innerHTML = '<i class="fas fa-check text-white text-xl"></i>';
            text.className = 'text-green-500';
            text.textContent = message;

            if (details) {
                document.getElementById('serverIP').textContent = details.server_ip || '-';
                document.getElementById('serverPort').textContent = details.rcon_port || '-';
                detailsDiv.classList.remove('hidden');
            }
        } else {
            icon.className = 'w-12 h-12 bg-red-500 rounded-full flex items-center justify-center';
            icon.innerHTML = '<i class="fas fa-times text-white text-xl"></i>';
            text.className = 'text-red-500';
            text.textContent = message;

            if (details && details.error) {
                detailsDiv.classList.remove('hidden');
                document.getElementById('serverIP').textContent = details.server_ip || '-';
                document.getElementById('serverPort').textContent = details.rcon_port || '-';
            }
        }

        // Show debug info
        if (details && details.config_debug) {
            const debug = details.config_debug;
            let debugHtml = '';

            if (debug.be_config_found) {
                debugHtml += `<div class="text-green-400">âœ“ BattlEye Config gefunden</div>`;
                debugHtml += `<div>Config-Datei: <span class="text-yellow-400">${debug.config_file || 'Unknown'}</span></div>`;
                debugHtml += `<div>RCon Port: ${debug.rcon_port}</div>`;
                debugHtml += `<div>RCon IP: ${debug.rcon_ip}</div>`;
                debugHtml += `<div>Passwort gesetzt: ${debug.password_set}</div>`;
                if (debug.password_length) {
                    debugHtml += `<div>Passwort LÃ¤nge: ${debug.password_length} Zeichen</div>`;
                }
                if (debug.password_preview) {
                    debugHtml += `<div>Passwort (Preview): <span class="text-yellow-400">${debug.password_preview}</span></div>`;
                }
            } else {
                debugHtml += `<div class="text-red-400">âœ— BattlEye Config nicht gefunden</div>`;
                debugHtml += `<div>BE Pfad: ${debug.be_path || 'N/A'}</div>`;
                if (debug.be_path_exists === false) {
                    debugHtml += `<div class="text-red-400">âœ— BattlEye Verzeichnis existiert nicht!</div>`;
                } else if (debug.config_files_found) {
                    if (debug.config_files_found.length > 0) {
                        debugHtml += `<div class="text-yellow-400">Gefundene Dateien:</div>`;
                        debug.config_files_found.forEach(file => {
                            debugHtml += `<div class="ml-4">â€¢ ${file}</div>`;
                        });
                    } else {
                        debugHtml += `<div class="text-red-400">Keine beserver_x64*.cfg Dateien gefunden</div>`;
                    }
                }
            }

            debugContent.innerHTML = debugHtml;
            debugDiv.classList.remove('hidden');
        }
    }

    function loadPlayers() {
        fetch(`/api/server/${serverId}/rcon/players`)
            .then(response => response.json())
            .then(data => {
                displayPlayers(data.players || []);
            })
            .catch(error => {
                console.error('Error loading players:', error);
            });
    }

    function displayPlayers(players) {
        const container = document.getElementById('playersList');
        const count = document.getElementById('playerCount');

        count.textContent = players.length;

        if (players.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-user-slash text-4xl mb-2"></i>
                    <p>Keine Spieler online</p>
                </div>
            `;
            return;
        }

        container.innerHTML = players.map(player => `
            <div class="bg-[#0D1117] border border-[#E32345]/30 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-white truncate">${escapeHtml(player.name)}</div>
                        <div class="text-xs text-gray-500">ID: ${player.id} | Ping: ${player.ping}</div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="kickPlayer('${player.id}', '${escapeHtml(player.name)}')" class="px-2 py-1 bg-red-500 hover:bg-red-600 rounded text-xs transition" title="Kick">
                            <i class="fas fa-shoe-prints"></i>
                        </button>
                        <button onclick="banPlayer('${player.id}', '${escapeHtml(player.name)}')" class="px-2 py-1 bg-purple-500 hover:bg-purple-600 rounded text-xs transition" title="Ban">
                            <i class="fas fa-ban"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function startPlayersRefresh() {
        playersInterval = setInterval(loadPlayers, 10000); // Refresh every 10 seconds
    }

    function kickPlayer(playerId, playerName) {
        if (!confirm(`MÃ¶chtest du ${playerName} wirklich kicken?`)) return;

        showLoading('Kicke Spieler...');
        fetch(`/api/server/${serverId}/rcon/kick/${playerId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addToConsole(`âœ“ Spieler ${playerName} (ID: ${playerId}) wurde gekickt`);
                setTimeout(loadPlayers, 1000);
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Fehler beim Kicken des Spielers');
        });
    }

    function kickAllPlayers() {
        if (!confirm('MÃ¶chtest du wirklich ALLE Spieler kicken?')) return;

        showLoading('Kicke alle Spieler...');
        fetch(`/api/server/${serverId}/rcon/kickall`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reason: 'Admin action'})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addToConsole(`âœ“ ${data.message}`);
                setTimeout(loadPlayers, 1000);
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Fehler beim Kicken aller Spieler');
        });
    }

    function banPlayer(playerId, playerName) {
        const minutes = prompt(`Wie lange mÃ¶chtest du ${playerName} bannen?\n\n0 = Permanent\n1-999999 = Minuten`, '0');
        if (minutes === null) return;

        const reason = prompt('Ban-Grund:', 'VerstoÃŸ gegen Serverregeln');
        if (reason === null) return;

        showLoading('Banne Spieler...');
        fetch(`/api/server/${serverId}/rcon/ban/${playerId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                minutes: parseInt(minutes) || 0,
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addToConsole(`âœ“ Spieler ${playerName} (ID: ${playerId}) wurde gebannt`);
                setTimeout(loadPlayers, 1000);
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Fehler beim Bannen des Spielers');
        });
    }

    function lockServer() {
        if (!confirm('MÃ¶chtest du den Server wirklich sperren?\n\nKeine neuen Spieler kÃ¶nnen mehr joinen.')) return;

        showLoading('Sperre Server...');
        fetch(`/api/server/${serverId}/rcon/lock`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addToConsole('ðŸ”’ Server wurde gesperrt');
                alert('Server gesperrt! Keine neuen Spieler kÃ¶nnen mehr joinen.');
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Fehler beim Sperren des Servers');
        });
    }

    function unlockServer() {
        if (!confirm('MÃ¶chtest du den Server entsperren?')) return;

        showLoading('Entsperre Server...');
        fetch(`/api/server/${serverId}/rcon/unlock`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addToConsole('ðŸ”“ Server wurde entsperrt');
                alert('Server entsperrt! Spieler kÃ¶nnen wieder joinen.');
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Fehler beim Entsperren des Servers');
        });
    }

    function sendCommand() {
        const input = document.getElementById('commandInput');
        const command = input.value.trim();

        if (!command) return;

        addToConsole(`> ${command}`);
        input.value = '';

        fetch(`/api/server/${serverId}/rcon/command`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({command: command})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addToConsole(data.response || 'âœ“ Befehl ausgefÃ¼hrt');
            } else {
                addToConsole(`âœ— Fehler: ${data.response}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addToConsole('âœ— Verbindungsfehler', 'error');
        });
    }

    function quickCommand(command) {
        document.getElementById('commandInput').value = command;
        sendCommand();
    }

    function sendQuickMessage() {
        const input = document.getElementById('quickMessage');
        const message = input.value.trim();

        if (!message) {
            alert('Bitte gib eine Nachricht ein');
            return;
        }

        showLoading('Sende Nachricht...');
        fetch(`/api/server/${serverId}/rcon/message`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                addToConsole(`âœ“ Nachricht gesendet: ${message}`);
                input.value = '';
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Fehler beim Senden der Nachricht');
        });
    }

    function addToConsole(text, type = 'info') {
        const console = document.getElementById('consoleOutput');
        const timestamp = new Date().toLocaleTimeString('de-DE');
        const color = type === 'error' ? 'text-red-400' : 'text-green-400';

        const entry = document.createElement('div');
        entry.className = color + ' mb-1';
        entry.textContent = `[${timestamp}] ${text}`;

        console.appendChild(entry);
        console.scrollTop = console.scrollHeight;
    }

    function clearConsole() {
        document.getElementById('consoleOutput').innerHTML = '<div class="text-gray-500">Console geleert.</div>';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showLoading(message) {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingModal').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingModal').classList.add('hidden');
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (playersInterval) {
            clearInterval(playersInterval);
        }
    });
</script>
{% endblock %}
