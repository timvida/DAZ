{% extends "base.html" %}

{% block title %}{{ server.name }} - Configuration{% endblock %}

{% block content %}
<style>
.server-layout {
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.sidebar {
    width: 250px;
    background: #1a1a1a;
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #333;
}

.sidebar-header h2 {
    margin: 0;
    font-size: 1.2em;
    color: #00ff00;
}

.sidebar-nav {
    flex: 1;
    padding: 20px 0;
}

.sidebar-nav a {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: #fff;
    text-decoration: none;
    transition: background 0.2s;
}

.sidebar-nav a:hover, .sidebar-nav a.active {
    background: #2a2a2a;
    border-left: 3px solid #00ff00;
}

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.topbar {
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.topbar-left h1 {
    margin: 0;
    font-size: 1.5em;
}

.topbar-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.content-area {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
    background: #0a0a0a;
}

.alert-banner {
    background: #ff9900;
    color: #000;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
    align-items: center;
    justify-content: space-between;
}

.alert-banner.show {
    display: flex;
}

.config-section {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
}

.config-section h3 {
    margin-top: 0;
    color: #00ff00;
    border-bottom: 1px solid #333;
    padding-bottom: 10px;
}

.config-field {
    margin-bottom: 20px;
}

.config-field label {
    display: block;
    margin-bottom: 5px;
    color: #fff;
    font-weight: bold;
}

.config-field .description {
    display: block;
    margin-bottom: 8px;
    color: #888;
    font-size: 0.9em;
}

.config-field input[type="text"],
.config-field input[type="number"],
.config-field select,
.config-field textarea {
    width: 100%;
    padding: 10px;
    background: #0a0a0a;
    border: 1px solid #333;
    border-radius: 4px;
    color: #fff;
    font-size: 1em;
}

.config-field input[type="checkbox"] {
    width: auto;
    margin-right: 10px;
}

.save-indicator {
    display: inline-block;
    margin-left: 10px;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.85em;
    opacity: 0;
    transition: opacity 0.3s;
}

.save-indicator.saving {
    background: #ff9900;
    color: #000;
    opacity: 1;
}

.save-indicator.saved {
    background: #00ff00;
    color: #000;
    opacity: 1;
}

.save-indicator.error {
    background: #ff0000;
    color: #fff;
    opacity: 1;
}
</style>

<div class="server-layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>{{ server.name }}</h2>
            <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #888;">Port: {{ server.server_port }}</p>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('server_dashboard', server_id=server.id) }}">
                <span>üìä Dashboard</span>
            </a>
            <a href="{{ url_for('server_config', server_id=server.id) }}" class="active">
                <span>‚öôÔ∏è Configuration</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <h1>Server Configuration</h1>
            </div>
            <div class="topbar-right">
                <span class="user-info">{{ username }}</span>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">Main Dashboard</a>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Restart Alert -->
            <div class="alert-banner" id="restartAlert">
                <span>‚ö†Ô∏è Configuration changed. Restart server to apply changes.</span>
                <button class="btn btn-warning btn-sm" onclick="restartServer()">Restart Now</button>
            </div>

            <!-- Basic Settings -->
            <div class="config-section">
                <h3>Basic Server Settings</h3>

                <div class="config-field">
                    <label for="hostname">Server Name
                        <span class="save-indicator" id="save-hostname">Saved</span>
                    </label>
                    <span class="description">The name of your server as it appears in the server browser</span>
                    <input type="text" id="hostname" data-config-key="hostname" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="password">Server Password
                        <span class="save-indicator" id="save-password">Saved</span>
                    </label>
                    <span class="description">Password required to join the server (leave empty for public server)</span>
                    <input type="text" id="password" data-config-key="password" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="passwordAdmin">Admin Password
                        <span class="save-indicator" id="save-passwordAdmin">Saved</span>
                    </label>
                    <span class="description">Password to become a server admin</span>
                    <input type="text" id="passwordAdmin" data-config-key="passwordAdmin" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="description">Server Description
                        <span class="save-indicator" id="save-description">Saved</span>
                    </label>
                    <span class="description">Description displayed in the server browser</span>
                    <textarea id="description" data-config-key="description" rows="3" oninput="saveField(this)"></textarea>
                </div>

                <div class="config-field">
                    <label for="maxPlayers">Max Players
                        <span class="save-indicator" id="save-maxPlayers">Saved</span>
                    </label>
                    <span class="description">Maximum number of players allowed on the server</span>
                    <input type="number" id="maxPlayers" data-config-key="maxPlayers" min="1" max="127" oninput="saveField(this)">
                </div>
            </div>

            <!-- Gameplay Settings -->
            <div class="config-section">
                <h3>Gameplay Settings</h3>

                <div class="config-field">
                    <label for="disable3rdPerson">
                        <input type="checkbox" id="disable3rdPerson" data-config-key="disable3rdPerson" onchange="saveField(this)">
                        Disable 3rd Person View
                        <span class="save-indicator" id="save-disable3rdPerson">Saved</span>
                    </label>
                    <span class="description">When enabled, players can only use first-person view</span>
                </div>

                <div class="config-field">
                    <label for="disableCrosshair">
                        <input type="checkbox" id="disableCrosshair" data-config-key="disableCrosshair" onchange="saveField(this)">
                        Disable Crosshair
                        <span class="save-indicator" id="save-disableCrosshair">Saved</span>
                    </label>
                    <span class="description">When enabled, the crosshair is hidden</span>
                </div>

                <div class="config-field">
                    <label for="disablePersonalLight">
                        <input type="checkbox" id="disablePersonalLight" data-config-key="disablePersonalLight" onchange="saveField(this)">
                        Disable Personal Light
                        <span class="save-indicator" id="save-disablePersonalLight">Saved</span>
                    </label>
                    <span class="description">Disables personal light for all players</span>
                </div>

                <div class="config-field">
                    <label for="lightingConfig">Lighting Configuration
                        <span class="save-indicator" id="save-lightingConfig">Saved</span>
                    </label>
                    <span class="description">0 for brighter nights, 1 for darker nights</span>
                    <select id="lightingConfig" data-config-key="lightingConfig" onchange="saveField(this)">
                        <option value="0">Brighter Nights</option>
                        <option value="1">Darker Nights</option>
                    </select>
                </div>
            </div>

            <!-- Time Settings -->
            <div class="config-section">
                <h3>Time Settings</h3>

                <div class="config-field">
                    <label for="serverTime">Server Time
                        <span class="save-indicator" id="save-serverTime">Saved</span>
                    </label>
                    <span class="description">Initial server time. Use "SystemTime" for real-time or format: YYYY/MM/DD/HH/MM</span>
                    <input type="text" id="serverTime" data-config-key="serverTime" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="serverTimeAcceleration">Time Acceleration
                        <span class="save-indicator" id="save-serverTimeAcceleration">Saved</span>
                    </label>
                    <span class="description">Time multiplier (0-24). Value of 12 means 1 real hour = 12 game hours</span>
                    <input type="number" id="serverTimeAcceleration" data-config-key="serverTimeAcceleration" min="0" max="24" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="serverNightTimeAcceleration">Night Time Acceleration
                        <span class="save-indicator" id="save-serverNightTimeAcceleration">Saved</span>
                    </label>
                    <span class="description">Night time multiplier (0.1-64), also multiplied by serverTimeAcceleration</span>
                    <input type="number" id="serverNightTimeAcceleration" data-config-key="serverNightTimeAcceleration" min="0.1" max="64" step="0.1" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="serverTimePersistent">
                        <input type="checkbox" id="serverTimePersistent" data-config-key="serverTimePersistent" onchange="saveField(this)">
                        Persistent Time
                        <span class="save-indicator" id="save-serverTimePersistent">Saved</span>
                    </label>
                    <span class="description">When enabled, server time is saved and persists across restarts</span>
                </div>
            </div>

            <!-- Voice & Communication -->
            <div class="config-section">
                <h3>Voice & Communication</h3>

                <div class="config-field">
                    <label for="disableVoN">
                        <input type="checkbox" id="disableVoN" data-config-key="disableVoN" onchange="saveField(this)">
                        Disable Voice Over Network
                        <span class="save-indicator" id="save-disableVoN">Saved</span>
                    </label>
                    <span class="description">When enabled, voice chat is disabled</span>
                </div>

                <div class="config-field">
                    <label for="vonCodecQuality">Voice Codec Quality
                        <span class="save-indicator" id="save-vonCodecQuality">Saved</span>
                    </label>
                    <span class="description">Voice quality (0-30). Higher is better but uses more bandwidth</span>
                    <input type="number" id="vonCodecQuality" data-config-key="vonCodecQuality" min="0" max="30" oninput="saveField(this)">
                </div>
            </div>

            <!-- Advanced Settings -->
            <div class="config-section">
                <h3>Advanced Settings</h3>

                <div class="config-field">
                    <label for="shardId">Shard ID
                        <span class="save-indicator" id="save-shardId">Saved</span>
                    </label>
                    <span class="description">Six alphanumeric characters for private servers (e.g., "123abc")</span>
                    <input type="text" id="shardId" data-config-key="shardId" maxlength="6" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="enableWhitelist">
                        <input type="checkbox" id="enableWhitelist" data-config-key="enableWhitelist" onchange="saveField(this)">
                        Enable Whitelist
                        <span class="save-indicator" id="save-enableWhitelist">Saved</span>
                    </label>
                    <span class="description">Only whitelisted players can join</span>
                </div>

                <div class="config-field">
                    <label for="verifySignatures">Verify Signatures
                        <span class="save-indicator" id="save-verifySignatures">Saved</span>
                    </label>
                    <span class="description">Verifies mod files (only value 2 is supported)</span>
                    <input type="number" id="verifySignatures" data-config-key="verifySignatures" value="2" readonly>
                </div>

                <div class="config-field">
                    <label for="forceSameBuild">
                        <input type="checkbox" id="forceSameBuild" data-config-key="forceSameBuild" onchange="saveField(this)">
                        Force Same Build
                        <span class="save-indicator" id="save-forceSameBuild">Saved</span>
                    </label>
                    <span class="description">Only allow clients with the same game version</span>
                </div>

                <div class="config-field">
                    <label for="storageAutoFix">
                        <input type="checkbox" id="storageAutoFix" data-config-key="storageAutoFix" onchange="saveField(this)">
                        Storage Auto-Fix
                        <span class="save-indicator" id="save-storageAutoFix">Saved</span>
                    </label>
                    <span class="description">Automatically fix corrupted persistence files</span>
                </div>

                <div class="config-field">
                    <label for="instanceId">Instance ID
                        <span class="save-indicator" id="save-instanceId">Saved</span>
                    </label>
                    <span class="description">Server instance identifier for multiple servers on same machine</span>
                    <input type="number" id="instanceId" data-config-key="instanceId" min="1" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="loginQueueConcurrentPlayers">Login Queue Concurrent Players
                        <span class="save-indicator" id="save-loginQueueConcurrentPlayers">Saved</span>
                    </label>
                    <span class="description">Number of players processed concurrently during login</span>
                    <input type="number" id="loginQueueConcurrentPlayers" data-config-key="loginQueueConcurrentPlayers" min="1" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="loginQueueMaxPlayers">Login Queue Max Players
                        <span class="save-indicator" id="save-loginQueueMaxPlayers">Saved</span>
                    </label>
                    <span class="description">Maximum players that can wait in login queue</span>
                    <input type="number" id="loginQueueMaxPlayers" data-config-key="loginQueueMaxPlayers" min="1" oninput="saveField(this)">
                </div>

                <div class="config-field">
                    <label for="guaranteedUpdates">Guaranteed Updates
                        <span class="save-indicator" id="save-guaranteedUpdates">Saved</span>
                    </label>
                    <span class="description">Communication protocol (always use 1)</span>
                    <input type="number" id="guaranteedUpdates" data-config-key="guaranteedUpdates" value="1" readonly>
                </div>
            </div>

            <!-- Mission Settings -->
            <div class="config-section">
                <h3>Mission Settings</h3>

                <div class="config-field">
                    <label for="missionTemplate">Map / Mission
                        <span class="save-indicator" id="save-missionTemplate">Saved</span>
                    </label>
                    <span class="description">Select the map for your server</span>
                    <select id="missionTemplate" data-config-key="missionTemplate" onchange="saveField(this)">
                        <option value="dayzOffline.chernarusplus">Chernarus (Base Game)</option>
                        <option value="dayzOffline.enoch">Livonia (DLC)</option>
                        <option value="dayzOffline.sakhal">Sakhal (DLC)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const serverId = {{ server.id }};
let configData = {};
let saveTimeout = null;
let configChanged = false;

// Parse config file
function parseConfig(configText) {
    const config = {};
    const lines = configText.split('\n');

    for (let line of lines) {
        line = line.trim();
        if (line.startsWith('//') || !line) continue;

        // Parse template from Missions class
        if (line.includes('template')) {
            const match = line.match(/template\s*=\s*"([^"]+)"/);
            if (match) config.missionTemplate = match[1];
            continue;
        }

        // Parse regular key = value pairs
        const match = line.match(/^(\w+)\s*=\s*(.+?);/);
        if (match) {
            let [, key, value] = match;
            value = value.trim();

            // Remove everything after // (comments)
            const commentIndex = value.indexOf('//');
            if (commentIndex !== -1) {
                value = value.substring(0, commentIndex).trim();
            }

            // Remove quotes if present
            if (value.startsWith('"') && value.endsWith('"')) {
                value = value.slice(1, -1);
            }

            config[key] = value;
        }
    }

    return config;
}

// Load config
function loadConfig() {
    fetch(`/api/server/${serverId}/config`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                configData = parseConfig(data.config);
                populateForm();
            }
        })
        .catch(error => console.error('Error loading config:', error));
}

// Populate form with config data
function populateForm() {
    for (let key in configData) {
        const element = document.querySelector(`[data-config-key="${key}"]`);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = configData[key] == '1';
            } else {
                element.value = configData[key];
            }
        }
    }
}

// Save individual field
function saveField(element) {
    const key = element.dataset.configKey;
    const indicator = document.getElementById(`save-${key}`);

    // Update config data
    if (element.type === 'checkbox') {
        configData[key] = element.checked ? '1' : '0';
    } else {
        configData[key] = element.value;
    }

    // Show saving indicator
    indicator.className = 'save-indicator saving';
    indicator.textContent = 'Saving...';

    // Mark as changed
    configChanged = true;
    document.getElementById('restartAlert').classList.add('show');

    // Debounce save
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        saveConfig(indicator);
    }, 500);
}

// Save entire config
function saveConfig(indicator) {
    // Build config content
    let configContent = `// ${document.getElementById('hostname').value} - DayZ Server Configuration\n`;
    configContent += `// Auto-generated by GameServer Manager\n\n`;

    // Add all config values
    for (let key in configData) {
        if (key === 'missionTemplate') continue; // Handle separately

        const value = configData[key];
        const needsQuotes = isNaN(value) && value !== '0' && value !== '1';

        if (needsQuotes) {
            configContent += `${key} = "${value}";\n`;
        } else {
            configContent += `${key} = ${value};\n`;
        }
    }

    // Add Missions class
    configContent += `\nclass Missions\n{\n    class DayZ\n    {\n`;
    configContent += `        template = "${configData.missionTemplate || 'dayzOffline.chernarusplus'}";\n`;
    configContent += `    };\n};\n`;

    // Save to server
    fetch(`/api/server/${serverId}/config`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({config: configContent})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (indicator) {
                indicator.className = 'save-indicator saved';
                indicator.textContent = 'Saved';
                setTimeout(() => {
                    indicator.className = 'save-indicator';
                }, 2000);
            }
        } else {
            if (indicator) {
                indicator.className = 'save-indicator error';
                indicator.textContent = 'Error';
            }
        }
    })
    .catch(error => {
        console.error('Error saving config:', error);
        if (indicator) {
            indicator.className = 'save-indicator error';
            indicator.textContent = 'Error';
        }
    });
}

// Restart server
function restartServer() {
    if (!confirm('Restart the server now? This will disconnect all players.')) {
        return;
    }

    fetch(`/api/server/${serverId}/restart`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            configChanged = false;
            document.getElementById('restartAlert').classList.remove('show');
            // Redirect to dashboard
            window.location.href = `/server/${serverId}/dashboard`;
        }
    })
    .catch(error => {
        alert('Error restarting server: ' + error);
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadConfig();
});
</script>
{% endblock %}
