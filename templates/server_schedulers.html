{% extends "base.html" %}

{% block title %}{{ server.name }} - Scheduler{% endblock %}

{% block page_title %}{{ server.name }}{% endblock %}
{% block page_subtitle %}Automated Scheduler{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('server_dashboard', server_id=server.id) }}" class="flex items-center gap-2 px-4 py-2 bg-[#0D1117] hover:bg-[#E32345]/10 border border-[#E32345]/30 rounded-lg transition">
    <i class="fas fa-arrow-left"></i>
    <span class="hidden lg:inline">Back to Dashboard</span>
</a>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6 mb-6">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-white mb-2">Scheduler Management</h2>
                <p class="text-gray-400">Automate server restarts and messages</p>
            </div>
            <button onclick="openCreateScheduler()" class="px-6 py-3 bg-[#E32345] hover:bg-[#c41d39] rounded-lg font-medium transition shadow-lg shadow-[#E32345]/20 hover:shadow-[#E32345]/40 flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>New Scheduler</span>
            </button>
        </div>
    </div>

    <!-- Active Schedulers Count -->
    <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-4 mb-6">
        <div class="flex items-center gap-3">
            <i class="fas fa-clock text-[#E32345] text-xl"></i>
            <span class="text-white font-medium">Active Schedulers: <strong id="activeCount">0</strong></span>
        </div>
    </div>

    <!-- Schedulers List -->
    <div id="schedulersList" class="space-y-4">
        <!-- Scheduler items will be inserted here -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-12 text-center hidden">
        <i class="fas fa-calendar-xmark text-gray-600 text-5xl mb-4"></i>
        <h3 class="text-xl font-bold text-white mb-2">No Schedulers Created</h3>
        <p class="text-gray-400 mb-6">Create your first scheduler to automate server tasks</p>
        <button onclick="openCreateScheduler()" class="px-6 py-3 bg-[#E32345] hover:bg-[#c41d39] rounded-lg font-medium transition inline-flex items-center gap-2">
            <i class="fas fa-plus"></i>
            <span>Create First Scheduler</span>
        </button>
    </div>
</div>

<!-- Create/Edit Scheduler Modal - STEP BY STEP -->
<div id="schedulerModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 overflow-y-auto p-4">
    <div class="min-h-screen flex items-center justify-center py-8">
        <div class="bg-[#1A1F29] border border-[#E32345]/30 rounded-2xl max-w-3xl w-full p-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex-1">
                    <h3 class="text-2xl font-bold text-white" id="modalTitle">New Scheduler</h3>
                    <p class="text-sm text-gray-400 mt-1" id="modalSubtitle">Step 1 of 3</p>
                </div>
                <button onclick="closeSchedulerModal()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="flex justify-between mb-2">
                    <span class="text-xs text-gray-400">Progress</span>
                    <span class="text-xs text-gray-400"><span id="currentStep">1</span>/3</span>
                </div>
                <div class="h-2 bg-[#0D1117] rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-[#E32345] transition-all duration-300" style="width: 33%"></div>
                </div>
            </div>

            <form id="schedulerForm">
                <input type="hidden" id="schedulerId" value="">

                <!-- STEP 1: Name -->
                <div id="step1" class="step-content">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-[#E32345]/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-signature text-[#E32345] text-3xl"></i>
                        </div>
                        <h4 class="text-xl font-bold text-white mb-2">Name Your Scheduler</h4>
                        <p class="text-gray-400">Give your scheduler a unique name</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Name <span class="text-[#E32345]">*</span>
                        </label>
                        <input type="text" id="schedulerName" required class="w-full px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition text-lg" placeholder="e.g. Daily Restart 03:00">
                        <p class="text-xs text-gray-500 mt-2">ðŸ’¡ Tip: Use descriptive names like "Restart Monday 4 AM" or "Maintenance Notice every 2h"</p>
                    </div>
                </div>

                <!-- STEP 2: Action Type -->
                <div id="step2" class="step-content hidden">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-[#E32345]/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-bolt text-[#E32345] text-3xl"></i>
                        </div>
                        <h4 class="text-xl font-bold text-white mb-2">Choose Action</h4>
                        <p class="text-gray-400">What should the scheduler do?</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button type="button" onclick="selectAction('restart')" class="action-card group p-6 bg-[#0D1117] border-2 border-[#E32345]/30 rounded-xl hover:border-[#E32345] transition cursor-pointer">
                            <div class="flex flex-col items-center text-center">
                                <div class="w-16 h-16 bg-orange-500/20 rounded-full flex items-center justify-center mb-4 group-hover:bg-orange-500/30 transition">
                                    <i class="fas fa-rotate-right text-orange-500 text-2xl"></i>
                                </div>
                                <h5 class="text-lg font-bold text-white mb-2">Restart Server</h5>
                                <p class="text-sm text-gray-400">Automatic server restart with warnings and player kick</p>
                            </div>
                        </button>

                        <button type="button" onclick="selectAction('message')" class="action-card group p-6 bg-[#0D1117] border-2 border-[#E32345]/30 rounded-xl hover:border-[#E32345] transition cursor-pointer">
                            <div class="flex flex-col items-center text-center">
                                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mb-4 group-hover:bg-blue-500/30 transition">
                                    <i class="fas fa-message text-blue-500 text-2xl"></i>
                                </div>
                                <h5 class="text-lg font-bold text-white mb-2">Send Message</h5>
                                <p class="text-sm text-gray-400">Send global message to all players</p>
                            </div>
                        </button>
                    </div>
                    <input type="hidden" id="actionType">
                </div>

                <!-- STEP 3A: Restart Configuration -->
                <div id="step3restart" class="step-content hidden">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-[#E32345]/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-rotate-right text-[#E32345] text-3xl"></i>
                        </div>
                        <h4 class="text-xl font-bold text-white mb-2">Configure Restart</h4>
                        <p class="text-gray-400">Set time and options</p>
                    </div>

                    <div class="space-y-6">
                        <!-- Time Selection -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Hour <span class="text-[#E32345]">*</span>
                                </label>
                                <select id="schedulerHour" class="w-full px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition">
                                    <option value="">Select...</option>
                                    <script>
                                        for (let i = 0; i < 24; i++) {
                                            document.write(`<option value="${i}">${String(i).padStart(2, '0')}:00</option>`);
                                        }
                                    </script>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Minute <span class="text-[#E32345]">*</span>
                                </label>
                                <select id="schedulerMinute" class="w-full px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition">
                                    <option value="">Select...</option>
                                    <script>
                                        for (let i = 0; i < 60; i += 5) {
                                            document.write(`<option value="${i}">${String(i).padStart(2, '0')}</option>`);
                                        }
                                    </script>
                                </select>
                            </div>
                        </div>

                        <!-- Weekdays -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">
                                Weekdays <span class="text-[#E32345]">*</span>
                            </label>
                            <div class="grid grid-cols-7 gap-2">
                                <button type="button" class="weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="0">Mon</button>
                                <button type="button" class="weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="1">Tue</button>
                                <button type="button" class="weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="2">Wed</button>
                                <button type="button" class="weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="3">Thu</button>
                                <button type="button" class="weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="4">Fri</button>
                                <button type="button" class="weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="5">Sat</button>
                                <button type="button" class="weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="6">Sun</button>
                            </div>
                        </div>

                        <!-- Restart Options -->
                        <div class="space-y-4 p-4 bg-[#0D1117] border border-[#E32345]/20 rounded-lg">
                            <h4 class="font-medium text-white mb-3 flex items-center gap-2">
                                <i class="fas fa-cog text-[#E32345]"></i>
                                Restart Settings
                            </h4>

                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="kickAllPlayers" checked class="w-5 h-5 bg-[#0D1117] border border-[#E32345]/30 rounded text-[#E32345] focus:ring-[#E32345]">
                                <label for="kickAllPlayers" class="text-gray-300">Kick all players</label>
                            </div>

                            <div id="kickOptions">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Minutes before restart for kick
                                </label>
                                <input type="number" id="kickMinutes" value="1" min="0" max="60" class="w-full px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Warning times (minutes before restart)
                                </label>
                                <div id="warningMinutesContainer" class="flex flex-wrap gap-2 mb-2">
                                    <!-- Warning tags will be inserted here -->
                                </div>
                                <div class="flex gap-2">
                                    <input type="number" id="newWarningMinute" min="1" max="120" placeholder="Minutes..." class="flex-1 px-4 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition">
                                    <button type="button" onclick="addWarningMinute()" class="px-4 py-2 bg-[#E32345] hover:bg-[#c41d39] rounded-lg transition">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 3B: Message Configuration -->
                <div id="step3message" class="step-content hidden">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-[#E32345]/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-message text-[#E32345] text-3xl"></i>
                        </div>
                        <h4 class="text-xl font-bold text-white mb-2">Configure Message</h4>
                        <p class="text-gray-400">Set schedule and message</p>
                    </div>

                    <div class="space-y-6">
                        <!-- Schedule Type Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">
                                Schedule Type <span class="text-[#E32345]">*</span>
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button type="button" onclick="selectScheduleType('cron')" class="schedule-type-btn group p-4 bg-[#0D1117] border-2 border-[#E32345]/30 rounded-xl hover:border-[#E32345] transition cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center group-hover:bg-green-500/30 transition">
                                            <i class="fas fa-clock text-green-500 text-xl"></i>
                                        </div>
                                        <div class="text-left">
                                            <h5 class="font-bold text-white mb-1">Fixed Time</h5>
                                            <p class="text-xs text-gray-400">e.g. every day at 12:00</p>
                                        </div>
                                    </div>
                                </button>

                                <button type="button" onclick="selectScheduleType('interval')" class="schedule-type-btn group p-4 bg-[#0D1117] border-2 border-[#E32345]/30 rounded-xl hover:border-[#E32345] transition cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 bg-purple-500/20 rounded-full flex items-center justify-center group-hover:bg-purple-500/30 transition">
                                            <i class="fas fa-repeat text-purple-500 text-xl"></i>
                                        </div>
                                        <div class="text-left">
                                            <h5 class="font-bold text-white mb-1">Every X Minutes</h5>
                                            <p class="text-xs text-gray-400">e.g. every 30 minutes</p>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" id="scheduleType">
                        </div>

                        <!-- Cron Schedule (Fixed Time) -->
                        <div id="cronScheduleConfig" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Hour <span class="text-[#E32345]">*</span>
                                    </label>
                                    <select id="messageHour" class="w-full px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition">
                                        <option value="">Select...</option>
                                        <script>
                                            for (let i = 0; i < 24; i++) {
                                                document.write(`<option value="${i}">${String(i).padStart(2, '0')}:00</option>`);
                                            }
                                        </script>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Minute <span class="text-[#E32345]">*</span>
                                    </label>
                                    <select id="messageMinute" class="w-full px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition">
                                        <option value="">Select...</option>
                                        <script>
                                            for (let i = 0; i < 60; i += 5) {
                                                document.write(`<option value="${i}">${String(i).padStart(2, '0')}</option>`);
                                            }
                                        </script>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">
                                    Weekdays <span class="text-[#E32345]">*</span>
                                </label>
                                <div class="grid grid-cols-7 gap-2">
                                    <button type="button" class="message-weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="0">Mon</button>
                                    <button type="button" class="message-weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="1">Tue</button>
                                    <button type="button" class="message-weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="2">Wed</button>
                                    <button type="button" class="message-weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="3">Thu</button>
                                    <button type="button" class="message-weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="4">Fri</button>
                                    <button type="button" class="message-weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="5">Sat</button>
                                    <button type="button" class="message-weekday-btn px-3 py-2 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white hover:bg-[#E32345]/20 transition text-sm" data-day="6">Sun</button>
                                </div>
                            </div>
                        </div>

                        <!-- Interval Schedule (Every X minutes) -->
                        <div id="intervalScheduleConfig" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Interval in Minutes <span class="text-[#E32345]">*</span>
                            </label>
                            <input type="number" id="intervalMinutes" min="1" max="1440" placeholder="e.g. 30 for every 30 minutes" class="w-full px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition">
                            <p class="text-xs text-gray-500 mt-2">ðŸ’¡ Popular values: 30, 60, 120 (2h), 180 (3h)</p>
                        </div>

                        <!-- Message Text -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Message <span class="text-[#E32345]">*</span>
                            </label>
                            <textarea id="customMessage" rows="3" class="w-full px-4 py-3 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] transition" placeholder="Your message to all players..." required></textarea>
                            <p class="text-xs text-gray-500 mt-2">ðŸ’¡ The message appears bottom-left in game</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex gap-3 pt-6 border-t border-[#E32345]/20 mt-8">
                    <button type="button" id="btnBack" onclick="previousStep()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-medium transition hidden">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                    <button type="button" onclick="closeSchedulerModal()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-medium transition">
                        Cancel
                    </button>
                    <button type="button" id="btnNext" onclick="nextStep()" class="flex-1 px-6 py-3 bg-[#E32345] hover:bg-[#c41d39] rounded-lg font-medium transition shadow-lg shadow-[#E32345]/20">
                        Next<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button type="button" id="btnSave" onclick="saveScheduler()" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition shadow-lg shadow-green-600/20 hidden">
                        <i class="fas fa-save mr-2"></i>Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-[#1A1F29] border border-[#E32345]/30 rounded-2xl max-w-md w-full p-8">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-[#E32345]/30 border-t-[#E32345] rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-white mb-2" id="loadingMessage">Loading...</h3>
        </div>
    </div>
</div>

<script>
    const serverId = {{ server.id }};

    // State variables
    let currentStep = 1;
    let selectedAction = null;
    let selectedScheduleType = null;
    let selectedWeekdays = new Set();
    let selectedMessageWeekdays = new Set();
    let warningMinutes = [60, 30, 15, 10, 5, 3, 2, 1];
    let editingSchedulerId = null;

    // Load schedulers on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSchedulers();
        setupEventListeners();
    });

    // ==== STEP NAVIGATION ====
    function nextStep() {
        // Validate current step
        if (currentStep === 1) {
            const name = document.getElementById('schedulerName').value.trim();
            if (!name) {
                alert('Please enter a name');
                return;
            }
        } else if (currentStep === 2) {
            if (!selectedAction) {
                alert('Please select an action');
                return;
            }
        }

        // Move to next step
        if (currentStep < 3) {
            currentStep++;
            updateStepDisplay();
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepDisplay();
        }
    }

    function updateStepDisplay() {
        // Hide all steps
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));

        // Show current step
        if (currentStep === 1) {
            document.getElementById('step1').classList.remove('hidden');
        } else if (currentStep === 2) {
            document.getElementById('step2').classList.remove('hidden');
        } else if (currentStep === 3) {
            if (selectedAction === 'restart') {
                document.getElementById('step3restart').classList.remove('hidden');
            } else if (selectedAction === 'message') {
                document.getElementById('step3message').classList.remove('hidden');
            }
        }

        // Update progress bar
        const progress = (currentStep / 3) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('currentStep').textContent = currentStep;
        document.getElementById('modalSubtitle').textContent = `Step ${currentStep} of 3`;

        // Update buttons
        document.getElementById('btnBack').classList.toggle('hidden', currentStep === 1);
        document.getElementById('btnNext').classList.toggle('hidden', currentStep === 3);
        document.getElementById('btnSave').classList.toggle('hidden', currentStep !== 3);
    }

    function selectAction(action) {
        selectedAction = action;
        document.getElementById('actionType').value = action;

        // Highlight selected card
        document.querySelectorAll('.action-card').forEach(card => {
            card.classList.remove('border-[#E32345]');
            card.classList.add('border-[#E32345]/30');
        });
        event.target.closest('.action-card').classList.remove('border-[#E32345]/30');
        event.target.closest('.action-card').classList.add('border-[#E32345]');

        setTimeout(() => nextStep(), 300);
    }

    function selectScheduleType(type) {
        selectedScheduleType = type;
        document.getElementById('scheduleType').value = type;

        // Highlight selected card
        document.querySelectorAll('.schedule-type-btn').forEach(btn => {
            btn.classList.remove('border-[#E32345]');
            btn.classList.add('border-[#E32345]/30');
        });
        event.target.closest('.schedule-type-btn').classList.remove('border-[#E32345]/30');
        event.target.closest('.schedule-type-btn').classList.add('border-[#E32345]');

        // Show/hide schedule config
        if (type === 'cron') {
            document.getElementById('cronScheduleConfig').classList.remove('hidden');
            document.getElementById('intervalScheduleConfig').classList.add('hidden');
        } else {
            document.getElementById('cronScheduleConfig').classList.add('hidden');
            document.getElementById('intervalScheduleConfig').classList.remove('hidden');
        }
    }

    function setupEventListeners() {
        // Restart Weekday buttons
        document.querySelectorAll('.weekday-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const day = parseInt(this.dataset.day);
                if (selectedWeekdays.has(day)) {
                    selectedWeekdays.delete(day);
                    this.classList.remove('bg-[#E32345]', 'border-[#E32345]');
                    this.classList.add('bg-[#0D1117]', 'border-[#E32345]/30');
                } else {
                    selectedWeekdays.add(day);
                    this.classList.add('bg-[#E32345]', 'border-[#E32345]');
                    this.classList.remove('bg-[#0D1117]', 'border-[#E32345]/30');
                }
            });
        });

        // Message Weekday buttons (separate set!)
        document.querySelectorAll('.message-weekday-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const day = parseInt(this.dataset.day);
                if (selectedMessageWeekdays.has(day)) {
                    selectedMessageWeekdays.delete(day);
                    this.classList.remove('bg-[#E32345]', 'border-[#E32345]');
                    this.classList.add('bg-[#0D1117]', 'border-[#E32345]/30');
                } else {
                    selectedMessageWeekdays.add(day);
                    this.classList.add('bg-[#E32345]', 'border-[#E32345]');
                    this.classList.remove('bg-[#0D1117]', 'border-[#E32345]/30');
                }
            });
        });

        // Kick players checkbox
        document.getElementById('kickAllPlayers').addEventListener('change', function() {
            const kickOptions = document.getElementById('kickOptions');
            if (this.checked) {
                kickOptions.classList.remove('hidden');
            } else {
                kickOptions.classList.add('hidden');
            }
        });
    }

    function loadSchedulers() {
        showLoading('Loading schedulers...');
        fetch(`/api/server/${serverId}/schedulers`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    displaySchedulers(data.schedulers);
                } else {
                    alert('Error loading schedulers');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                alert('Error loading schedulers');
            });
    }

    function displaySchedulers(schedulers) {
        const container = document.getElementById('schedulersList');
        const emptyState = document.getElementById('emptyState');
        const activeCount = schedulers.filter(s => s.is_active).length;

        document.getElementById('activeCount').textContent = activeCount;

        if (schedulers.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');
        container.innerHTML = schedulers.map(scheduler => createSchedulerCard(scheduler)).join('');
    }

    function createSchedulerCard(scheduler) {
        const weekdayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const actionIcon = scheduler.action_type === 'restart' ? 'fa-rotate-right' : 'fa-message';
        const actionText = scheduler.action_type === 'restart' ? 'Restart server' : 'Send message';
        const statusColor = scheduler.is_active ? 'green' : 'gray';
        const statusText = scheduler.is_active ? 'Active' : 'Inactive';

        // Determine schedule display based on type
        let scheduleInfo = '';
        const scheduleType = scheduler.schedule_type || 'cron';

        if (scheduleType === 'interval') {
            // Interval scheduler
            const interval = scheduler.interval_minutes || 60;
            scheduleInfo = `<span class="flex items-center gap-2">
                <i class="fas fa-repeat text-[#E32345]"></i>
                <strong class="text-white">Every ${interval} minutes</strong>
            </span>`;
        } else {
            // Cron scheduler
            const weekdaysStr = scheduler.weekdays.map(d => weekdayNames[d]).join(', ');
            const timeStr = `${String(scheduler.hour).padStart(2, '0')}:${String(scheduler.minute).padStart(2, '0')}`;
            scheduleInfo = `
                <span class="flex items-center gap-2">
                    <i class="fas fa-clock text-[#E32345]"></i>
                    <strong class="text-white">${timeStr}</strong>
                </span>
                <span class="flex items-center gap-2">
                    <i class="fas fa-calendar text-[#E32345]"></i>
                    <strong class="text-white">${weekdaysStr}</strong>
                </span>
            `;
        }

        return `
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-xl font-bold text-white">${scheduler.name}</h3>
                            <span class="px-3 py-1 bg-${statusColor}-500/20 border border-${statusColor}-500 text-${statusColor}-500 rounded-lg text-xs font-bold">
                                ${statusText}
                            </span>
                        </div>
                        <div class="flex flex-wrap gap-4 text-sm text-gray-400">
                            ${scheduleInfo}
                            <span class="flex items-center gap-2">
                                <i class="fas ${actionIcon} text-[#E32345]"></i>
                                <strong class="text-white">${actionText}</strong>
                            </span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" ${scheduler.is_active ? 'checked' : ''} onchange="toggleScheduler(${scheduler.id}, this.checked)" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#E32345]"></div>
                        </label>
                        <button onclick="editScheduler(${scheduler.id})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteScheduler(${scheduler.id})" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function openCreateScheduler() {
        editingSchedulerId = null;
        currentStep = 1;
        selectedAction = null;
        selectedScheduleType = null;
        selectedWeekdays.clear();
        selectedMessageWeekdays.clear();
        warningMinutes = [60, 30, 15, 10, 5, 3, 2, 1];

        document.getElementById('modalTitle').textContent = 'New Scheduler';
        document.getElementById('schedulerForm').reset();
        updateWarningMinutesDisplay();

        // Reset all weekday buttons
        document.querySelectorAll('.weekday-btn, .message-weekday-btn').forEach(btn => {
            btn.classList.remove('bg-[#E32345]', 'border-[#E32345]');
            btn.classList.add('bg-[#0D1117]', 'border-[#E32345]/30');
        });

        // Reset action/schedule type cards
        document.querySelectorAll('.action-card, .schedule-type-btn').forEach(card => {
            card.classList.remove('border-[#E32345]');
            card.classList.add('border-[#E32345]/30');
        });

        // Hide schedule configs
        document.getElementById('cronScheduleConfig').classList.add('hidden');
        document.getElementById('intervalScheduleConfig').classList.add('hidden');

        updateStepDisplay();
        document.getElementById('schedulerModal').classList.remove('hidden');
    }

    function closeSchedulerModal() {
        document.getElementById('schedulerModal').classList.add('hidden');
        currentStep = 1;
        selectedAction = null;
        selectedScheduleType = null;
    }

    function editScheduler(schedulerId) {
        showLoading('Loading scheduler...');
        fetch(`/api/scheduler/${schedulerId}`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    populateForm(data.scheduler);
                    document.getElementById('schedulerModal').classList.remove('hidden');
                } else {
                    alert('Error loading scheduler');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                alert('Error loading scheduler');
            });
    }

    function populateForm(scheduler) {
        editingSchedulerId = scheduler.id;
        document.getElementById('modalTitle').textContent = 'Edit Scheduler';
        document.getElementById('schedulerId').value = scheduler.id;
        document.getElementById('schedulerName').value = scheduler.name;
        document.getElementById('schedulerHour').value = scheduler.hour;
        document.getElementById('schedulerMinute').value = scheduler.minute;
        document.getElementById('actionType').value = scheduler.action_type;

        // Trigger action type change
        document.getElementById('actionType').dispatchEvent(new Event('change'));

        // Set weekdays
        selectedWeekdays = new Set(scheduler.weekdays);
        document.querySelectorAll('.weekday-btn').forEach(btn => {
            const day = parseInt(btn.dataset.day);
            if (selectedWeekdays.has(day)) {
                btn.classList.add('bg-[#E32345]', 'border-[#E32345]');
                btn.classList.remove('bg-[#0D1117]', 'border-[#E32345]/30');
            } else {
                btn.classList.remove('bg-[#E32345]', 'border-[#E32345]');
                btn.classList.add('bg-[#0D1117]', 'border-[#E32345]/30');
            }
        });

        if (scheduler.action_type === 'restart') {
            document.getElementById('kickAllPlayers').checked = scheduler.kick_all_players;
            document.getElementById('kickMinutes').value = scheduler.kick_minutes_before;
            warningMinutes = scheduler.warning_minutes || [60, 30, 15, 10, 5, 3, 2, 1];
            updateWarningMinutesDisplay();
        } else if (scheduler.action_type === 'message') {
            document.getElementById('customMessage').value = scheduler.custom_message || '';
        }
    }

    function closeSchedulerModal() {
        document.getElementById('schedulerModal').classList.add('hidden');
    }

    function saveScheduler() {
        const data = {
            name: document.getElementById('schedulerName').value.trim(),
            action_type: selectedAction
        };

        // Validation
        if (!data.name) {
            alert('Please enter a name');
            return;
        }

        if (!selectedAction) {
            alert('Please select an action');
            return;
        }

        // === Action-specific configuration ===
        if (selectedAction === 'restart') {
            // Restart requires cron schedule
            const hour = document.getElementById('schedulerHour').value;
            const minute = document.getElementById('schedulerMinute').value;

            if (!hour || !minute) {
                alert('Please select hour and minute');
                return;
            }

            if (selectedWeekdays.size === 0) {
                alert('Please select at least one weekday');
                return;
            }

            data.schedule_type = 'cron';
            data.hour = parseInt(hour);
            data.minute = parseInt(minute);
            data.weekdays = Array.from(selectedWeekdays);
            data.kick_all_players = document.getElementById('kickAllPlayers').checked;
            data.kick_minutes_before = parseInt(document.getElementById('kickMinutes').value);
            data.warning_minutes = warningMinutes;

        } else if (selectedAction === 'message') {
            const message = document.getElementById('customMessage').value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            data.custom_message = message;

            if (!selectedScheduleType) {
                alert('Please select a schedule type');
                return;
            }

            data.schedule_type = selectedScheduleType;

            if (selectedScheduleType === 'cron') {
                // Fixed time schedule
                const hour = document.getElementById('messageHour').value;
                const minute = document.getElementById('messageMinute').value;

                if (!hour || !minute) {
                    alert('Please select hour and minute');
                    return;
                }

                if (selectedMessageWeekdays.size === 0) {
                    alert('Please select at least one weekday');
                    return;
                }

                data.hour = parseInt(hour);
                data.minute = parseInt(minute);
                data.weekdays = Array.from(selectedMessageWeekdays);

            } else if (selectedScheduleType === 'interval') {
                // Interval schedule
                const interval = parseInt(document.getElementById('intervalMinutes').value);

                if (!interval || interval < 1) {
                    alert('Please enter a valid interval (at least 1 minute)');
                    return;
                }

                data.interval_minutes = interval;
            }
        }

        showLoading(editingSchedulerId ? 'Updating...' : 'Creating...');

        const url = editingSchedulerId
            ? `/api/scheduler/${editingSchedulerId}`
            : `/api/server/${serverId}/schedulers`;

        const method = editingSchedulerId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            hideLoading();
            if (result.success) {
                closeSchedulerModal();
                loadSchedulers();
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Error saving');
        });
    }

    function toggleScheduler(schedulerId, isActive) {
        fetch(`/api/scheduler/${schedulerId}/toggle`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({is_active: isActive})
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                loadSchedulers();
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error toggling');
        });
    }

    function deleteScheduler(schedulerId) {
        if (!confirm('Do you really want to delete this scheduler?')) return;

        showLoading('Deleting...');
        fetch(`/api/scheduler/${schedulerId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            hideLoading();
            if (result.success) {
                loadSchedulers();
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('Error deleting');
        });
    }

    function addWarningMinute() {
        const input = document.getElementById('newWarningMinute');
        const value = parseInt(input.value);

        if (!value || value < 1) {
            alert('Please enter a valid number of minutes');
            return;
        }

        if (warningMinutes.includes(value)) {
            alert('This warning already exists');
            return;
        }

        warningMinutes.push(value);
        warningMinutes.sort((a, b) => b - a);
        updateWarningMinutesDisplay();
        input.value = '';
    }

    function removeWarningMinute(minute) {
        warningMinutes = warningMinutes.filter(m => m !== minute);
        updateWarningMinutesDisplay();
    }

    function updateWarningMinutesDisplay() {
        const container = document.getElementById('warningMinutesContainer');
        container.innerHTML = warningMinutes.map(minute => `
            <span class="px-3 py-1 bg-[#E32345] rounded-lg text-white text-sm flex items-center gap-2">
                ${minute} Min
                <button type="button" onclick="removeWarningMinute(${minute})" class="hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </span>
        `).join('');
    }

    function showLoading(message) {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingModal').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingModal').classList.add('hidden');
    }
</script>
{% endblock %}
