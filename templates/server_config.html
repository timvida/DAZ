{% extends "base.html" %}

{% block title %}{{ server.name }} - Configuration{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style type="text/tailwindcss">
        @theme {
            --color-primary: #0D1117;
            --color-secondary: #1A1F29;
            --color-accent: #E32345;
        }
    </style>
</head>
<body class="bg-[#0D1117] text-white min-h-screen">
    <!-- Top Navigation -->
    <nav class="bg-[#1A1F29] border-b border-[#E32345]/20 sticky top-0 z-50 backdrop-blur-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo & Brand -->
                <div class="flex items-center gap-4">
                    <div class="bg-[#E32345] p-3 rounded-xl shadow-lg shadow-[#E32345]/20">
                        <i class="fas fa-cog text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">{{ server.name }}</h1>
                        <p class="text-sm text-gray-400">Server Configuration</p>
                    </div>
                </div>

                <!-- Navigation Items -->
                <div class="hidden md:flex items-center gap-6">
                    <a href="{{ url_for('server_dashboard', server_id=server.id) }}" class="flex items-center gap-2 text-gray-400 hover:text-white transition px-3 py-2 rounded-lg hover:bg-white/5">
                        <i class="fas fa-gauge-high"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="{{ url_for('server_config', server_id=server.id) }}" class="flex items-center gap-2 text-[#E32345] font-medium px-3 py-2 rounded-lg bg-[#E32345]/10">
                        <i class="fas fa-cog"></i>
                        <span>Configuration</span>
                    </a>
                </div>

                <!-- User & Actions -->
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-3 px-4 py-2 bg-[#0D1117] rounded-lg border border-[#E32345]/20">
                        <i class="fas fa-user-circle text-[#E32345]"></i>
                        <span class="hidden sm:block">{{ username }}</span>
                    </div>
                    <a href="{{ url_for('dashboard') }}" class="px-4 py-2 bg-[#0D1117] hover:bg-[#E32345]/10 border border-[#E32345]/30 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i>
                        <span class="hidden lg:inline">Main Dashboard</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Restart Alert -->
        <div id="restartAlert" class="hidden bg-yellow-500/20 border border-yellow-500 rounded-xl p-4 mb-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
                <span class="text-yellow-500 font-medium">Configuration changed. Restart server to apply changes.</span>
            </div>
            <button onclick="restartServer()" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg transition font-medium">
                Restart Now
            </button>
        </div>

        <!-- Config Sections -->
        <div class="space-y-6">
            <!-- Basic Settings -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-[#E32345]/20">
                    <i class="fas fa-info-circle text-[#E32345] text-2xl"></i>
                    <h2 class="text-2xl font-bold text-white">Basic Server Settings</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Server Name -->
                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-signature text-[#E32345]"></i>
                            <span>Server Name</span>
                            <span id="save-hostname" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">The name of your server as it appears in the server browser</p>
                        <input type="text" id="hostname" data-config-key="hostname" oninput="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                    </div>

                    <!-- Server Password -->
                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-lock text-[#E32345]"></i>
                            <span>Server Password</span>
                            <span id="save-password" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">Password required to join (leave empty for public)</p>
                        <input type="text" id="password" data-config-key="password" oninput="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                    </div>

                    <!-- Admin Password -->
                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-key text-[#E32345]"></i>
                            <span>Admin Password</span>
                            <span id="save-passwordAdmin" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">Password to become a server admin</p>
                        <input type="text" id="passwordAdmin" data-config-key="passwordAdmin" oninput="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                    </div>

                    <!-- Max Players -->
                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-users text-[#E32345]"></i>
                            <span>Max Players</span>
                            <span id="save-maxPlayers" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">Maximum number of players (1-127)</p>
                        <input type="number" id="maxPlayers" data-config-key="maxPlayers" min="1" max="127" oninput="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                    </div>

                    <!-- Server Description (full width) -->
                    <div class="md:col-span-2">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-file-lines text-[#E32345]"></i>
                            <span>Server Description</span>
                            <span id="save-description" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">Description displayed in the server browser</p>
                        <textarea id="description" data-config-key="description" rows="3" oninput="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition"></textarea>
                    </div>
                </div>
            </div>

            <!-- Gameplay Settings -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-[#E32345]/20">
                    <i class="fas fa-gamepad text-[#E32345] text-2xl"></i>
                    <h2 class="text-2xl font-bold text-white">Gameplay Settings</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                        <input type="checkbox" id="disable3rdPerson" data-config-key="disable3rdPerson" onchange="saveField(this)"
                            class="w-5 h-5 accent-[#E32345] cursor-pointer">
                        <div class="flex-1">
                            <label for="disable3rdPerson" class="font-medium text-white cursor-pointer flex items-center gap-2">
                                <i class="fas fa-eye-slash text-[#E32345]"></i>
                                Disable 3rd Person View
                                <span id="save-disable3rdPerson" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                            </label>
                            <p class="text-xs text-gray-400 mt-1">Players can only use first-person view</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                        <input type="checkbox" id="disableCrosshair" data-config-key="disableCrosshair" onchange="saveField(this)"
                            class="w-5 h-5 accent-[#E32345] cursor-pointer">
                        <div class="flex-1">
                            <label for="disableCrosshair" class="font-medium text-white cursor-pointer flex items-center gap-2">
                                <i class="fas fa-crosshairs text-[#E32345]"></i>
                                Disable Crosshair
                                <span id="save-disableCrosshair" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                            </label>
                            <p class="text-xs text-gray-400 mt-1">The crosshair is hidden</p>
                        </div>
                    </div>

                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-lightbulb text-[#E32345]"></i>
                            <span>Lighting Configuration</span>
                            <span id="save-lightingConfig" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">0 for brighter nights, 1 for darker nights</p>
                        <select id="lightingConfig" data-config-key="lightingConfig" onchange="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                            <option value="0">Brighter Nights</option>
                            <option value="1">Darker Nights</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Mission Settings -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl p-6">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-[#E32345]/20">
                    <i class="fas fa-map text-[#E32345] text-2xl"></i>
                    <h2 class="text-2xl font-bold text-white">Mission Settings</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-globe text-[#E32345]"></i>
                            <span>Map / Mission</span>
                            <span id="save-missionTemplate" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">Select the map for your server</p>
                        <select id="missionTemplate" data-config-key="missionTemplate" onchange="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                            <option value="dayzOffline.chernarusplus">Chernarus (Base Game)</option>
                            <option value="dayzOffline.enoch">Livonia (DLC)</option>
                            <option value="dayzOffline.sakhal">Sakhal (DLC)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const serverId = {{ server.id }};
        let configData = {};
        let saveTimeout = null;
        let configChanged = false;

        function parseConfig(configText) {
            const config = {};
            const lines = configText.split('\n');
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('//') || !line) continue;
                if (line.includes('template')) {
                    const match = line.match(/template\s*=\s*"([^"]+)"/);
                    if (match) config.missionTemplate = match[1];
                    continue;
                }
                const match = line.match(/^(\w+)\s*=\s*(.+?);/);
                if (match) {
                    let [, key, value] = match;
                    value = value.trim();
                    const commentIndex = value.indexOf('//');
                    if (commentIndex !== -1) value = value.substring(0, commentIndex).trim();
                    if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1);
                    config[key] = value;
                }
            }
            return config;
        }

        function loadConfig() {
            fetch(`/api/server/${serverId}/config`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        configData = parseConfig(data.config);
                        populateForm();
                    }
                })
                .catch(error => console.error('Error loading config:', error));
        }

        function populateForm() {
            for (let key in configData) {
                const element = document.querySelector(`[data-config-key="${key}"]`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = configData[key] == '1';
                    } else {
                        element.value = configData[key];
                    }
                }
            }
        }

        function saveField(element) {
            const key = element.dataset.configKey;
            const indicator = document.getElementById(`save-${key}`);

            if (element.type === 'checkbox') {
                configData[key] = element.checked ? '1' : '0';
            } else {
                configData[key] = element.value;
            }

            indicator.textContent = 'Saving...';
            indicator.className = 'text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-500 opacity-100 transition-opacity';

            configChanged = true;
            document.getElementById('restartAlert').classList.remove('hidden');

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveConfig(indicator), 500);
        }

        function saveConfig(indicator) {
            let configContent = `// ${document.getElementById('hostname').value} - DayZ Server Configuration\n`;
            configContent += `// Auto-generated by GameServer Manager\n\n`;

            for (let key in configData) {
                if (key === 'missionTemplate') continue;
                const value = configData[key];
                const needsQuotes = isNaN(value) && value !== '0' && value !== '1';
                configContent += needsQuotes ? `${key} = "${value}";\n` : `${key} = ${value};\n`;
            }

            configContent += `\nclass Missions\n{\n    class DayZ\n    {\n`;
            configContent += `        template = "${configData.missionTemplate || 'dayzOffline.chernarusplus'}";\n`;
            configContent += `    };\n};\n`;

            fetch(`/api/server/${serverId}/config`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({config: configContent})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    indicator.textContent = 'Saved';
                    indicator.className = 'text-xs px-2 py-1 rounded bg-green-500/20 text-green-500 opacity-100 transition-opacity';
                    setTimeout(() => indicator.className = 'text-xs px-2 py-1 rounded opacity-0 transition-opacity', 2000);
                } else {
                    indicator.textContent = 'Error';
                    indicator.className = 'text-xs px-2 py-1 rounded bg-red-500/20 text-red-500 opacity-100 transition-opacity';
                }
            });
        }

        function restartServer() {
            if (!confirm('Restart the server now? This will disconnect all players.')) return;
            fetch(`/api/server/${serverId}/restart`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    configChanged = false;
                    document.getElementById('restartAlert').classList.add('hidden');
                    window.location.href = `/server/${serverId}/dashboard`;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });
    </script>
</body>
</html>
{% endblock %}
