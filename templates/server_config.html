{% extends "base.html" %}

{% block title %}{{ server.name }} - Configuration{% endblock %}

{% block page_title %}{{ server.name }}{% endblock %}
{% block page_subtitle %}Server Configuration{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('server_dashboard', server_id=server.id) }}" class="flex items-center gap-2 px-4 py-2 bg-[#0D1117] hover:bg-[#E32345]/10 border border-[#E32345]/30 rounded-lg transition">
    <i class="fas fa-gauge-high"></i>
    <span class="hidden lg:inline">Dashboard</span>
</a>
{% endblock %}

{% block content %}
        <!-- Restart Alert -->
        <div id="restartAlert" class="hidden bg-yellow-500/20 border border-yellow-500 rounded-xl p-4 mb-6 flex items-center justify-between animate-pulse">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
                <span class="text-yellow-500 font-medium">Configuration changed. Restart server to apply changes.</span>
            </div>
            <button onclick="restartServer()" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg transition font-medium flex items-center gap-2">
                <i class="fas fa-rotate-right"></i>
                Restart Now
            </button>
        </div>

        <!-- Save All Button -->
        <div class="mb-6">
            <button onclick="saveAllConfig()" class="px-6 py-3 bg-[#E32345] hover:bg-[#c41d39] rounded-lg font-medium transition shadow-lg shadow-[#E32345]/20 hover:shadow-[#E32345]/40 flex items-center gap-2">
                <i class="fas fa-save"></i>
                <span>Save All Changes</span>
            </button>
        </div>

        <!-- Config Sections -->
        <div class="space-y-6">

            <!-- BASIC SERVER SETTINGS -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('basic')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-info-circle text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Basic Server Settings</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-basic"></i>
                </button>
                <div id="section-basic" class="p-6 border-t border-[#E32345]/20">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-signature text-[#E32345]"></i>
                                <span>Server Name (hostname)</span>
                                <span id="save-hostname" class="text-xs px-2 py-1 rounded opacity-0 transition-opacity"></span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">The name displayed in the server browser</p>
                            <input type="text" id="hostname" data-config-key="hostname" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition"
                                placeholder="My DayZ Server">
                        </div>

                        <div class="md:col-span-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-file-lines text-[#E32345]"></i>
                                <span>Description</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Server description (max 255 characters)</p>
                            <textarea id="description" data-config-key="description" rows="2" oninput="saveField(this)" maxlength="255"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition"
                                placeholder="Welcome to my server"></textarea>
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-lock text-[#E32345]"></i>
                                <span>Server Password</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Leave empty for public server</p>
                            <input type="text" id="password" data-config-key="password" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-key text-[#E32345]"></i>
                                <span>Admin Password</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Password to become server admin</p>
                            <input type="text" id="passwordAdmin" data-config-key="passwordAdmin" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-users text-[#E32345]"></i>
                                <span>Max Players</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Maximum number of players (1-127)</p>
                            <input type="number" id="maxPlayers" data-config-key="maxPlayers" min="1" max="127" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECURITY SETTINGS -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('security')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-shield-halved text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Security Settings</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-security"></i>
                </button>
                <div id="section-security" class="hidden p-6 border-t border-[#E32345]/20">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-certificate text-[#E32345]"></i>
                                <span>Verify Signatures</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Verifies .pbos against .bisign files (only 2 is supported)</p>
                            <input type="number" id="verifySignatures" data-config-key="verifySignatures" min="0" max="2" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="BattlEye" data-config-key="BattlEye" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="BattlEye" class="font-medium text-white cursor-pointer">BattlEye Anti-Cheat</label>
                                <p class="text-xs text-gray-400 mt-1">Enable BattlEye protection (recommended)</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="forceSameBuild" data-config-key="forceSameBuild" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="forceSameBuild" class="font-medium text-white cursor-pointer">Force Same Build</label>
                                <p class="text-xs text-gray-400 mt-1">Only allow clients with same version</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="enableWhitelist" data-config-key="enableWhitelist" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="enableWhitelist" class="font-medium text-white cursor-pointer">Enable Whitelist</label>
                                <p class="text-xs text-gray-400 mt-1">Only whitelisted players can join</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="disableBanlist" data-config-key="disableBanlist" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="disableBanlist" class="font-medium text-white cursor-pointer">Disable Banlist</label>
                                <p class="text-xs text-gray-400 mt-1">Disables the usage of ban.txt</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="disablePrioritylist" data-config-key="disablePrioritylist" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="disablePrioritylist" class="font-medium text-white cursor-pointer">Disable Priority List</label>
                                <p class="text-xs text-gray-400 mt-1">Disables usage of priority.txt</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GAMEPLAY SETTINGS -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('gameplay')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-gamepad text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Gameplay Settings</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-gameplay"></i>
                </button>
                <div id="section-gameplay" class="hidden p-6 border-t border-[#E32345]/20">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="disable3rdPerson" data-config-key="disable3rdPerson" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="disable3rdPerson" class="font-medium text-white cursor-pointer">Disable 3rd Person</label>
                                <p class="text-xs text-gray-400 mt-1">Force first-person view only</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="disableCrosshair" data-config-key="disableCrosshair" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="disableCrosshair" class="font-medium text-white cursor-pointer">Disable Crosshair</label>
                                <p class="text-xs text-gray-400 mt-1">Hide the crosshair</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="disableMap" data-config-key="disableMap" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="disableMap" class="font-medium text-white cursor-pointer">Disable Map</label>
                                <p class="text-xs text-gray-400 mt-1">Disable in-game map</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="disablePersonalLight" data-config-key="disablePersonalLight" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="disablePersonalLight" class="font-medium text-white cursor-pointer">Disable Personal Light</label>
                                <p class="text-xs text-gray-400 mt-1">Disable player's personal light</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="disableVoN" data-config-key="disableVoN" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="disableVoN" class="font-medium text-white cursor-pointer">Disable Voice Chat (VoN)</label>
                                <p class="text-xs text-gray-400 mt-1">Disable voice over network</p>
                            </div>
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-microphone text-[#E32345]"></i>
                                <span>Voice Codec Quality</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Voice quality (0-20, higher is better)</p>
                            <input type="number" id="vonCodecQuality" data-config-key="vonCodecQuality" min="0" max="20" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-clock-rotate-left text-[#E32345]"></i>
                                <span>Respawn Time</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Time in seconds before respawn</p>
                            <input type="number" id="respawnTime" data-config-key="respawnTime" min="0" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TIME SETTINGS -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('time')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-clock text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Time Settings</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-time"></i>
                </button>
                <div id="section-time" class="hidden p-6 border-t border-[#E32345]/20">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-calendar text-[#E32345]"></i>
                                <span>Server Time</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Initial time: "SystemTime" or "YYYY/MM/DD/HH/MM"</p>
                            <input type="text" id="serverTime" data-config-key="serverTime" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition"
                                placeholder="SystemTime">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-forward text-[#E32345]"></i>
                                <span>Time Acceleration</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Time multiplier (0.1-64), 24 = 24x faster</p>
                            <input type="number" id="serverTimeAcceleration" data-config-key="serverTimeAcceleration" min="0.1" max="64" step="0.1" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-moon text-[#E32345]"></i>
                                <span>Night Time Acceleration</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Night multiplier (0.1-64), multiplied by time acceleration</p>
                            <input type="number" id="serverNightTimeAcceleration" data-config-key="serverNightTimeAcceleration" min="0.1" max="64" step="0.1" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="serverTimePersistent" data-config-key="serverTimePersistent" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="serverTimePersistent" class="font-medium text-white cursor-pointer">Persistent Time</label>
                                <p class="text-xs text-gray-400 mt-1">Save time to disk, continues on restart</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONNECTION & PORTS -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('connection')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-network-wired text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Connection & Network</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-connection"></i>
                </button>
                <div id="section-connection" class="hidden p-6 border-t border-[#E32345]/20">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-hashtag text-[#E32345]"></i>
                                <span>Instance ID</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Server instance identifier</p>
                            <input type="number" id="instanceId" data-config-key="instanceId" min="1" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-users-line text-[#E32345]"></i>
                                <span>Login Queue Concurrent</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Players processed concurrently during login</p>
                            <input type="number" id="loginQueueConcurrentPlayers" data-config-key="loginQueueConcurrentPlayers" min="1" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-users-line text-[#E32345]"></i>
                                <span>Login Queue Max</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Maximum players in login queue</p>
                            <input type="number" id="loginQueueMaxPlayers" data-config-key="loginQueueMaxPlayers" min="1" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-sync text-[#E32345]"></i>
                                <span>Guaranteed Updates</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Communication protocol (use only 1)</p>
                            <input type="number" id="guaranteedUpdates" data-config-key="guaranteedUpdates" value="1" readonly
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-gray-500 cursor-not-allowed">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADVANCED SETTINGS -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('advanced')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-sliders text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Advanced Settings</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-advanced"></i>
                </button>
                <div id="section-advanced" class="hidden p-6 border-t border-[#E32345]/20">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-file text-[#E32345]"></i>
                                <span>Log File</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Server log filename</p>
                            <input type="text" id="logFile" data-config-key="logFile" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition"
                                placeholder="server_console.log">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-file text-[#E32345]"></i>
                                <span>Admin Log File</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Admin log filename</p>
                            <input type="text" id="adminLogFile" data-config-key="adminLogFile" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition"
                                placeholder="admin_console.log">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-clock text-[#E32345]"></i>
                                <span>Timestamp Format</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Log timestamp format</p>
                            <select id="timeStampFormat" data-config-key="timeStampFormat" onchange="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                                <option value="Short">Short</option>
                                <option value="Full">Full</option>
                                <option value="None">None</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="storageAutoFix" data-config-key="storageAutoFix" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="storageAutoFix" class="font-medium text-white cursor-pointer">Storage Auto-Fix</label>
                                <p class="text-xs text-gray-400 mt-1">Auto-fix corrupted persistence files</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-[#0D1117] rounded-lg border border-[#E32345]/30">
                            <input type="checkbox" id="storeHouseStateDisabled" data-config-key="storeHouseStateDisabled" onchange="saveField(this)"
                                class="w-5 h-5 accent-[#E32345] cursor-pointer">
                            <div class="flex-1">
                                <label for="storeHouseStateDisabled" class="font-medium text-white cursor-pointer">Disable Store House State</label>
                                <p class="text-xs text-gray-400 mt-1">Disable building persistence</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MOTD (Message of the Day) -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('motd')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-message text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Message of the Day (MOTD)</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-motd"></i>
                </button>
                <div id="section-motd" class="hidden p-6 border-t border-[#E32345]/20">
                    <div class="space-y-4">
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-align-left text-[#E32345]"></i>
                                <span>MOTD Messages (one per line)</span>
                            </label>
                            <p class="text-xs text-gray-400 mb-2">Messages shown to players when joining</p>
                            <textarea id="motd" data-config-key="motd" rows="4" oninput="saveField(this)"
                                class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition font-mono text-sm"
                                placeholder="Welcome to My DayZ Server&#10;Enjoy your stay!&#10;Discord: discord.gg/example"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-hourglass text-[#E32345]"></i>
                                    <span>MOTD Interval (minutes)</span>
                                </label>
                                <p class="text-xs text-gray-400 mb-2">How often to show MOTD</p>
                                <input type="number" id="motdInterval" data-config-key="motdInterval" min="1" oninput="saveField(this)"
                                    class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MISSION SETTINGS -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('mission')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-map text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Mission Settings</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-mission"></i>
                </button>
                <div id="section-mission" class="hidden p-6 border-t border-[#E32345]/20">
                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-globe text-[#E32345]"></i>
                            <span>Map / Mission Template</span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">Select the map for your server</p>
                        <select id="missionTemplate" data-config-key="missionTemplate" onchange="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition">
                            <option value="dayzOffline.chernarusplus">Chernarus (Base Game)</option>
                            <option value="dayzOffline.enoch">Livonia (DLC)</option>
                            <option value="dayzOffline.sakhal">Sakhal (DLC)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- CUSTOM CONFIG -->
            <div class="bg-[#1A1F29] border border-[#E32345]/20 rounded-xl overflow-hidden">
                <button onclick="toggleSection('custom')" class="w-full flex items-center justify-between p-6 hover:bg-[#E32345]/5 transition">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-code text-[#E32345] text-2xl"></i>
                        <h2 class="text-2xl font-bold text-white">Custom Configuration</h2>
                    </div>
                    <i class="fas fa-chevron-down text-[#E32345] transition-transform" id="chevron-custom"></i>
                </button>
                <div id="section-custom" class="hidden p-6 border-t border-[#E32345]/20">
                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                            <i class="fas fa-file-code text-[#E32345]"></i>
                            <span>Additional Config Lines</span>
                        </label>
                        <p class="text-xs text-gray-400 mb-2">Add custom configuration parameters (one per line, format: key = value;)</p>
                        <textarea id="customConfig" data-config-key="customConfig" rows="6" oninput="saveField(this)"
                            class="w-full px-4 py-2.5 bg-[#0D1117] border border-[#E32345]/30 rounded-lg text-white focus:outline-none focus:border-[#E32345] focus:ring-2 focus:ring-[#E32345]/20 transition font-mono text-sm"
                            placeholder="// Custom settings&#10;myCustomSetting = 1;&#10;anotherSetting = &quot;value&quot;;"></textarea>
                        <div class="mt-2 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                            <p class="text-sm text-blue-400 flex items-center gap-2">
                                <i class="fas fa-info-circle"></i>
                                <span>These lines will be added to the end of serverDZ.cfg before the Missions class</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    <script>
        const serverId = {{ server.id }};
        let configData = {};
        let configChanged = false;

        function toggleSection(sectionName) {
            const section = document.getElementById('section-' + sectionName);
            const chevron = document.getElementById('chevron-' + sectionName);

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                section.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function markChanged(element) {
            configChanged = true;
            document.getElementById('restartAlert').classList.remove('hidden');
        }

        // Debounce function for auto-save
        let saveTimers = {};

        function saveField(element) {
            const key = element.dataset.configKey;

            // Clear existing timer for this field
            if (saveTimers[key]) {
                clearTimeout(saveTimers[key]);
            }

            // Mark as changed
            markChanged(element);

            // Set new timer (wait 1 second after typing stops)
            saveTimers[key] = setTimeout(() => {
                // Get value
                let value;
                if (element.type === 'checkbox') {
                    value = element.checked ? '1' : '0';
                } else {
                    value = element.value;
                }

                // Update config data
                configData[key] = value;

                // Show saving indicator
                const indicator = document.getElementById('save-' + key);
                if (indicator) {
                    indicator.textContent = 'Saving...';
                    indicator.className = 'text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400 opacity-100 transition-opacity';
                }

                // Build and save config
                saveConfigSilent().then(success => {
                    if (indicator) {
                        if (success) {
                            indicator.textContent = '✓ Saved';
                            indicator.className = 'text-xs px-2 py-1 rounded bg-green-500/20 text-green-400 opacity-100 transition-opacity';
                        } else {
                            indicator.textContent = '✗ Error';
                            indicator.className = 'text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 opacity-100 transition-opacity';
                        }

                        // Fade out after 2 seconds
                        setTimeout(() => {
                            indicator.style.opacity = '0';
                        }, 2000);
                    }
                });
            }, 1000); // 1 second debounce
        }

        async function saveConfigSilent() {
            // Collect all form data
            document.querySelectorAll('[data-config-key]').forEach(element => {
                const key = element.dataset.configKey;
                if (element.type === 'checkbox') {
                    configData[key] = element.checked ? '1' : '0';
                } else {
                    configData[key] = element.value;
                }
            });

            // Build config file (same as saveAllConfig)
            let configContent = `// ${configData.hostname || 'DayZ Server'} - Server Configuration\n`;
            configContent += `// Generated by GameServer Manager\n\n`;

            // Basic settings
            configContent += `hostname = "${configData.hostname || 'My DayZ Server'}";\n`;
            if (configData.description) configContent += `description = "${configData.description}";\n`;
            configContent += `password = "${configData.password || ''}";\n`;
            configContent += `passwordAdmin = "${configData.passwordAdmin || ''}";\n`;
            configContent += `maxPlayers = ${configData.maxPlayers || 60};\n\n`;

            // Security
            configContent += `verifySignatures = ${configData.verifySignatures || 2};\n`;
            configContent += `forceSameBuild = ${configData.forceSameBuild || 0};\n`;
            configContent += `BattlEye = ${configData.BattlEye || 1};\n`;
            configContent += `enableWhitelist = ${configData.enableWhitelist || 0};\n`;
            if (configData.disableBanlist !== undefined) configContent += `disableBanlist = ${configData.disableBanlist == '1' ? 'true' : 'false'};\n`;
            if (configData.disablePrioritylist !== undefined) configContent += `disablePrioritylist = ${configData.disablePrioritylist == '1' ? 'true' : 'false'};\n`;
            configContent += `\n`;

            // Gameplay
            configContent += `disable3rdPerson = ${configData.disable3rdPerson || 0};\n`;
            configContent += `disableCrosshair = ${configData.disableCrosshair || 0};\n`;
            if (configData.disableMap !== undefined) configContent += `disableMap = ${configData.disableMap};\n`;
            if (configData.disablePersonalLight !== undefined) configContent += `disablePersonalLight = ${configData.disablePersonalLight};\n`;
            configContent += `disableVoN = ${configData.disableVoN || 0};\n`;
            configContent += `vonCodecQuality = ${configData.vonCodecQuality || 20};\n`;
            if (configData.respawnTime) configContent += `respawnTime = ${configData.respawnTime};\n`;
            configContent += `\n`;

            // Time
            configContent += `serverTime = "${configData.serverTime || 'SystemTime'}";\n`;
            configContent += `serverTimeAcceleration = ${configData.serverTimeAcceleration || 1};\n`;
            configContent += `serverNightTimeAcceleration = ${configData.serverNightTimeAcceleration || 1};\n`;
            configContent += `serverTimePersistent = ${configData.serverTimePersistent || 0};\n\n`;

            // Connection
            configContent += `instanceId = ${configData.instanceId || 1};\n`;
            configContent += `guaranteedUpdates = ${configData.guaranteedUpdates || 1};\n`;
            configContent += `loginQueueConcurrentPlayers = ${configData.loginQueueConcurrentPlayers || 5};\n`;
            configContent += `loginQueueMaxPlayers = ${configData.loginQueueMaxPlayers || 500};\n\n`;

            // Advanced
            if (configData.logFile) configContent += `logFile = "${configData.logFile}";\n`;
            if (configData.adminLogFile) configContent += `adminLogFile = "${configData.adminLogFile}";\n`;
            if (configData.timeStampFormat) configContent += `timeStampFormat = "${configData.timeStampFormat}";\n`;
            configContent += `storageAutoFix = ${configData.storageAutoFix || 1};\n`;
            if (configData.storeHouseStateDisabled !== undefined) configContent += `storeHouseStateDisabled = ${configData.storeHouseStateDisabled == '1' ? 'true' : 'false'};\n`;
            configContent += `\n`;

            // MOTD
            if (configData.motd) {
                const motdLines = configData.motd.split('\n').filter(line => line.trim());
                if (motdLines.length > 0) {
                    configContent += `motd[] = {\n`;
                    motdLines.forEach(line => {
                        configContent += `    "${line.trim()}",\n`;
                    });
                    configContent += `};\n`;
                    if (configData.motdInterval) configContent += `motdInterval = ${configData.motdInterval};\n`;
                    configContent += `\n`;
                }
            }

            // Custom config
            if (configData.customConfig) {
                configContent += `// Custom Configuration\n`;
                configContent += configData.customConfig.trim() + '\n\n';
            }

            // Missions
            configContent += `class Missions\n{\n    class DayZ\n    {\n`;
            configContent += `        template = "${configData.missionTemplate || 'dayzOffline.chernarusplus'}";\n`;
            configContent += `    };\n};\n`;

            // Save to server
            try {
                const response = await fetch(`/api/server/${serverId}/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({config: configContent})
                });
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error('Error saving config:', error);
                return false;
            }
        }

        function parseConfig(configText) {
            const config = {};
            const lines = configText.split('\n');
            let inMotd = false;
            let motdLines = [];
            let customLines = [];
            let inMissions = false;

            for (let line of lines) {
                line = line.trim();

                // Skip comments and empty lines
                if (line.startsWith('//') || !line) {
                    continue;
                }

                // Handle Missions class
                if (line.includes('class Missions')) {
                    inMissions = true;
                    continue;
                }

                if (inMissions && line.includes('template')) {
                    const match = line.match(/template\s*=\s*"([^"]+)"/);
                    if (match) config.missionTemplate = match[1];
                    continue;
                }

                // Handle MOTD array
                if (line.includes('motd[]')) {
                    inMotd = true;
                    continue;
                }

                if (inMotd) {
                    if (line === '};') {
                        inMotd = false;
                        config.motd = motdLines.join('\n');
                        continue;
                    }
                    const msgMatch = line.match(/"([^"]+)"/);
                    if (msgMatch) {
                        motdLines.push(msgMatch[1]);
                    }
                    continue;
                }

                // Regular key = value pairs
                const match = line.match(/^(\w+)\s*=\s*(.+?);/);
                if (match) {
                    let [, key, value] = match;
                    value = value.trim();

                    // Remove inline comments
                    const commentIndex = value.indexOf('//');
                    if (commentIndex !== -1) {
                        value = value.substring(0, commentIndex).trim();
                    }

                    // Remove quotes if present
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }

                    config[key] = value;
                }
            }

            return config;
        }

        function loadConfig() {
            fetch(`/api/server/${serverId}/config`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        configData = parseConfig(data.config);
                        populateForm();
                    }
                })
                .catch(error => console.error('Error loading config:', error));
        }

        function populateForm() {
            for (let key in configData) {
                const element = document.querySelector(`[data-config-key="${key}"]`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = configData[key] == '1' || configData[key] === 'true';
                    } else {
                        element.value = configData[key];
                    }
                }
            }
        }

        function saveAllConfig() {
            // Collect all form data
            document.querySelectorAll('[data-config-key]').forEach(element => {
                const key = element.dataset.configKey;
                if (element.type === 'checkbox') {
                    configData[key] = element.checked ? '1' : '0';
                } else {
                    configData[key] = element.value;
                }
            });

            // Build config file
            let configContent = `// ${configData.hostname || 'DayZ Server'} - Server Configuration\n`;
            configContent += `// Generated by GameServer Manager\n\n`;

            // Basic settings
            configContent += `hostname = "${configData.hostname || 'My DayZ Server'}";\n`;
            if (configData.description) configContent += `description = "${configData.description}";\n`;
            configContent += `password = "${configData.password || ''}";\n`;
            configContent += `passwordAdmin = "${configData.passwordAdmin || ''}";\n`;
            configContent += `maxPlayers = ${configData.maxPlayers || 60};\n\n`;

            // Security
            configContent += `verifySignatures = ${configData.verifySignatures || 2};\n`;
            configContent += `forceSameBuild = ${configData.forceSameBuild || 0};\n`;
            configContent += `BattlEye = ${configData.BattlEye || 1};\n`;
            configContent += `enableWhitelist = ${configData.enableWhitelist || 0};\n`;
            if (configData.disableBanlist !== undefined) configContent += `disableBanlist = ${configData.disableBanlist == '1' ? 'true' : 'false'};\n`;
            if (configData.disablePrioritylist !== undefined) configContent += `disablePrioritylist = ${configData.disablePrioritylist == '1' ? 'true' : 'false'};\n`;
            configContent += `\n`;

            // Gameplay
            configContent += `disable3rdPerson = ${configData.disable3rdPerson || 0};\n`;
            configContent += `disableCrosshair = ${configData.disableCrosshair || 0};\n`;
            if (configData.disableMap !== undefined) configContent += `disableMap = ${configData.disableMap};\n`;
            if (configData.disablePersonalLight !== undefined) configContent += `disablePersonalLight = ${configData.disablePersonalLight};\n`;
            configContent += `disableVoN = ${configData.disableVoN || 0};\n`;
            configContent += `vonCodecQuality = ${configData.vonCodecQuality || 20};\n`;
            if (configData.respawnTime) configContent += `respawnTime = ${configData.respawnTime};\n`;
            configContent += `\n`;

            // Time
            configContent += `serverTime = "${configData.serverTime || 'SystemTime'}";\n`;
            configContent += `serverTimeAcceleration = ${configData.serverTimeAcceleration || 1};\n`;
            configContent += `serverNightTimeAcceleration = ${configData.serverNightTimeAcceleration || 1};\n`;
            configContent += `serverTimePersistent = ${configData.serverTimePersistent || 0};\n\n`;

            // Connection
            configContent += `instanceId = ${configData.instanceId || 1};\n`;
            configContent += `guaranteedUpdates = ${configData.guaranteedUpdates || 1};\n`;
            configContent += `loginQueueConcurrentPlayers = ${configData.loginQueueConcurrentPlayers || 5};\n`;
            configContent += `loginQueueMaxPlayers = ${configData.loginQueueMaxPlayers || 500};\n\n`;

            // Advanced
            if (configData.logFile) configContent += `logFile = "${configData.logFile}";\n`;
            if (configData.adminLogFile) configContent += `adminLogFile = "${configData.adminLogFile}";\n`;
            if (configData.timeStampFormat) configContent += `timeStampFormat = "${configData.timeStampFormat}";\n`;
            configContent += `storageAutoFix = ${configData.storageAutoFix || 1};\n`;
            if (configData.storeHouseStateDisabled !== undefined) configContent += `storeHouseStateDisabled = ${configData.storeHouseStateDisabled == '1' ? 'true' : 'false'};\n`;
            configContent += `\n`;

            // MOTD
            if (configData.motd) {
                const motdLines = configData.motd.split('\n').filter(line => line.trim());
                if (motdLines.length > 0) {
                    configContent += `motd[] = {\n`;
                    motdLines.forEach(line => {
                        configContent += `    "${line.trim()}",\n`;
                    });
                    configContent += `};\n`;
                    if (configData.motdInterval) configContent += `motdInterval = ${configData.motdInterval};\n`;
                    configContent += `\n`;
                }
            }

            // Custom config
            if (configData.customConfig) {
                configContent += `// Custom Configuration\n`;
                configContent += configData.customConfig.trim() + '\n\n';
            }

            // Missions
            configContent += `class Missions\n{\n    class DayZ\n    {\n`;
            configContent += `        template = "${configData.missionTemplate || 'dayzOffline.chernarusplus'}";\n`;
            configContent += `    };\n};\n`;

            // Save to server
            fetch(`/api/server/${serverId}/config`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({config: configContent})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                    configChanged = false;
                } else {
                    alert('Error saving configuration: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error saving configuration: ' + error);
            });
        }

        function restartServer() {
            if (!confirm('Restart the server now? This will disconnect all players.')) return;

            fetch(`/api/server/${serverId}/restart`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    configChanged = false;
                    document.getElementById('restartAlert').classList.add('hidden');
                    window.location.href = `/server/${serverId}/dashboard`;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });
    </script>
{% endblock %}
